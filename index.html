<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ru-prodcal-ics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>ru-prodcal-ics</h1>

<div class="meta" id="meta">Loading…</div>
<div class="meta" id="coverage">Calendar covers: —</div>

<div class="card">
  <div class="row">
    <div class="label">Subscribe URL</div>
    <div class="value mono" id="subscribeUrl">—</div>
  </div>

  <div class="buttons">
    <button class="copy-btn" id="copyBtn" type="button">Copy URL</button>
    <a class="btn" href="./prodcal.ics">Open .ics</a>
  </div>
</div>

<div class="card">
  <div class="label">Data source</div>
  <p class="text">
    Calendar data is sourced from
    <a href="https://hh.ru/calendar" target="_blank">hh.ru/calendar</a>
    and HeadHunter production calendar for
    <span id="years-links">—</span>.
  </p>
</div>

<script>
  function formatRelativeTime(date) {
    const diff = Math.floor((Date.now() - date.getTime()) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
    return `${Math.floor(diff / 86400)} days ago`;
  }

  async function loadMeta() {
    const metaEl = document.getElementById('meta');
    const coverageEl = document.getElementById('coverage');
    const subscribeEl = document.getElementById('subscribeUrl');
    const copyBtn = document.getElementById('copyBtn');
    const yearsLinksEl = document.getElementById('years-links');

    const baseUrl =
      location.origin +
      location.pathname.replace(/\/[^\/]*$/, '');

    let data = null;
    try {
      const res = await fetch('./meta.json', { cache: 'no-store' });
      if (res.ok) data = await res.json();
    } catch {}

    const subscribeUrl = data?.subscribeUrl || `${baseUrl}/prodcal.ics`;
    subscribeEl.textContent = subscribeUrl;
    copyBtn.dataset.url = subscribeUrl;

    if (data?.updatedAtUtc) {
      const d = new Date(data.updatedAtUtc);
      metaEl.textContent =
        `Updated ${formatRelativeTime(d)} (${d.toLocaleString()})`;
    } else {
      metaEl.textContent = 'Updated time unknown';
    }

    if (Number.isInteger(data?.startYear) && Number.isInteger(data?.endYear)) {
      coverageEl.textContent =
        `Calendar covers: ${data.startYear}–${data.endYear}`;

      yearsLinksEl.innerHTML = '';
      for (let y = data.startYear; y <= data.endYear; y++) {
        if (y !== data.startYear) yearsLinksEl.append(', ');
        const a = document.createElement('a');
        a.href = `https://hh.ru/article/calendar${y}`;
        a.textContent = y;
        a.target = '_blank';
        yearsLinksEl.appendChild(a);
      }
    }
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.copy-btn');
    if (!btn) return;

    try {
      await navigator.clipboard.writeText(btn.dataset.url);
      const old = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = old, 1200);
    } catch {
      alert('Copy failed');
    }
  });

  loadMeta();
</script>

</body>
</html>
